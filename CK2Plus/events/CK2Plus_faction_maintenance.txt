namespace = PlusFaction

#reserved: PlusFaction.200 to PlusFaction.299

##################################
# FACTION MAINTENANCE EVENTS
# Original Faction System by Wiz
# Re-Written by Rylock
##################################

# On-demand faction maintenance event
character_event = {
	id = PlusFaction.200

	is_triggered_only = yes
	hide_window = yes

	trigger = {
		higher_tier_than = COUNT
		is_nomadic = no
		is_landed = yes
		any_vassal = { pf_member_trigger = yes }
	}

	immediate = {
		character_event = { id = PlusFaction.221 } # setup effects

		#make any one-time adjustments to faction opinions (fired from events & decisions)
		any_vassal = {
			limit = {
				pf_leader_trigger = yes
				check_variable = { which = "faction_mood_increase" value = 0.1 }
			}
			character_event = { id = PlusFaction.223 } #one-time faction opinion increase
			set_variable = { which = "faction_mood_increase" value = 0 }
		}
		any_vassal = {
			limit = {
				pf_leader_trigger = yes
				check_variable = { which = "faction_mood_decrease" value = 0.1 }
			}
			character_event = { id = PlusFaction.224 } #one-time faction opinion decrease
			set_variable = { which = "faction_mood_decrease" value = 0 }
		}

		character_event = { id = PlusFaction.222 } # completion effects
	}
}

# Notification of court faction mood change
character_event = {
	id = PlusFaction.201
	picture = GFX_evt_council
	
	is_triggered_only = yes
	notification = yes
	hide_from = yes
	
	desc = {
		text = EVTDESC_PlusFaction_201_Happy
		trigger = {
			FROM = { has_character_flag = faction_court_happy }
		}
	}
	desc = {
		text = EVTDESC_PlusFaction_201_Neutral
		trigger = {
			FROM = {
				NOR = {
					has_character_flag = faction_court_happy
					has_character_flag = faction_court_unhappy
					has_character_flag = faction_court_angry
				}
			}
		}
	}
	desc = {
		text = EVTDESC_PlusFaction_201_Unhappy
		trigger = {
			FROM = { has_character_flag = faction_court_unhappy }
		}
	}
	desc = {
		text = EVTDESC_PlusFaction_201_Angry
		trigger = {
			FROM = { has_character_flag = faction_court_angry }
		}
	}
	
	option = {
		name = "OK"
	}
}

# Notification of prosperity faction mood change
character_event = {
	id = PlusFaction.202
	picture = GFX_evt_council
	
	is_triggered_only = yes
	notification = yes
	hide_from = yes
	
	desc = {
		text = EVTDESC_PlusFaction_202_Happy
		trigger = {
			FROM = { has_character_flag = faction_prosperity_happy }
		}
	}
	desc = {
		text = EVTDESC_PlusFaction_202_Neutral
		trigger = {
			FROM = {
				NOR = {
					has_character_flag = faction_prosperity_happy
					has_character_flag = faction_prosperity_unhappy
					has_character_flag = faction_prosperity_angry
				}
			}
		}
	}
	desc = {
		text = EVTDESC_PlusFaction_202_Unhappy
		trigger = {
			FROM = { has_character_flag = faction_prosperity_unhappy }
		}
	}
	desc = {
		text = EVTDESC_PlusFaction_202_Angry
		trigger = {
			FROM = { has_character_flag = faction_prosperity_angry }
		}
	}
	
	option = {
		name = "OK"
	}
}

# Notification of glory faction mood change
character_event = {
	id = PlusFaction.203
	picture = GFX_evt_council
	
	is_triggered_only = yes
	notification = yes
	hide_from = yes
	
	desc = {
		text = EVTDESC_PlusFaction_203_Happy
		trigger = {
			FROM = { has_character_flag = faction_glory_happy }
		}
	}
	desc = {
		text = EVTDESC_PlusFaction_203_Neutral
		trigger = {
			FROM = {
				NOR = {
					has_character_flag = faction_glory_happy
					has_character_flag = faction_glory_unhappy
					has_character_flag = faction_glory_angry
				}
			}
		}
	}
	desc = {
		text = EVTDESC_PlusFaction_203_Unhappy
		trigger = {
			FROM = { has_character_flag = faction_glory_unhappy }
		}
	}
	desc = {
		text = EVTDESC_PlusFaction_203_Angry
		trigger = {
			FROM = { has_character_flag = faction_glory_angry }
		}
	}
	
	option = {
		name = "OK"
	}
}

# Notification of tradition faction mood change
character_event = {
	id = PlusFaction.204
	picture = GFX_evt_council
	
	is_triggered_only = yes
	notification = yes
	hide_from = yes
	
	desc = {
		text = EVTDESC_PlusFaction_204_Happy
		trigger = {
			FROM = { has_character_flag = faction_tradition_happy }
		}
	}
	desc = {
		text = EVTDESC_PlusFaction_204_Neutral
		trigger = {
			FROM = {
				NOR = {
					has_character_flag = faction_tradition_happy
					has_character_flag = faction_tradition_unhappy
					has_character_flag = faction_tradition_angry
				}
			}
		}
	}
	desc = {
		text = EVTDESC_PlusFaction_204_Unhappy
		trigger = {
			FROM = { has_character_flag = faction_tradition_unhappy }
		}
	}
	desc = {
		text = EVTDESC_PlusFaction_204_Angry
		trigger = {
			FROM = { has_character_flag = faction_tradition_angry }
		}
	}
	
	option = {
		name = "OK"
	}
}

# Faction maintenance on character death
character_event = {
	id = PlusFaction.205

	is_triggered_only = yes
	hide_window = yes
	
	only_playable = yes

	trigger = { current_heir = { is_alive = yes } }

	immediate = {
		#convenience
		current_heir = { save_event_target_as = heir }

		#pass on proper flags to the heir if currently in a faction revolt
		pf_inherit_war_flags_effect = yes
		
		#pass down laws if the heir is inheriting a new primary title
		if = {
			limit = {
				current_heir = { lower_tier_than = ROOT }
			}
			current_heir = {
				clr_character_flag = lifetime_appointments
				clr_character_flag = max_levies
			}
			if = {
				limit = { has_character_flag = lifetime_appointments }
				current_heir = {
					set_character_flag = lifetime_appointments
					if = {
						limit = { is_ruler = yes }
						job_spymaster = { remove_title = job_spymaster remove_opinion = { who = PREV modifier = opinion_fired_from_council } }
						job_marshal = { remove_title = job_marshal remove_opinion = { who = PREV modifier = opinion_fired_from_council } }
						job_chancellor = { remove_title = job_chancellor remove_opinion = { who = PREV modifier = opinion_fired_from_council } }
						job_treasurer = { remove_title = job_treasurer remove_opinion = { who = PREV modifier = opinion_fired_from_council } }
						job_spiritual = { remove_title = job_spiritual remove_opinion = { who = PREV modifier = opinion_fired_from_council } }
					}
				}
			}
			if = {
				limit = { has_character_flag = max_levies }
				current_heir = { set_character_flag = max_levies }
			}
		}

		# Pass on any civil war state we may have versus *OUR* liege

		if = { # Sanity check, first.
			limit = {
				trait = rebel
				NOR = {
					any_war = { # Secondary participant revolter
						any_attacker = { character = ROOT } # Non-faction participant in this war or revolt leader
						OR = {
							using_cb = cb_faction_overthrow_ruler
							using_cb = religious_overthrow_ruler
							using_cb = claim_on_liege_plot
							using_cb = other_claim_on_liege_plot
							using_cb = cb_faction_independence
						}
					}
					AND = { # Faction member revolter (also works for revolt leaders, as does above)
						in_revolt = yes
						liege = {
							any_war = {
								attacker = { character = PREVPREV } # Liege is a revolt leader
								OR = {
									using_cb = cb_faction_overthrow_ruler
									using_cb = religious_overthrow_ruler
									using_cb = claim_on_liege_plot
									using_cb = other_claim_on_liege_plot
									using_cb = cb_faction_independence
								}
							}
						}
					}
				}
			}
			log = "PlusFaction.205: SERIOUS: dying ruler had `rebel` trait but isn't involved in a PF revolt: [This.GetTitledFirstName] of the [This.PrimaryTitle.GetFullBaseName] (ID: [This.GetID])"
			remove_trait = rebel
		}

		# Are we a revolt leader?
		if = {
			limit = {
				in_revolt = yes
				independent = no
				liege = { character = PREV }
			}
			set_character_flag = is_revolt_leader_temp
		}

		if = {
			limit = {
				NOT = { has_character_flag = is_revolt_leader_temp }
				has_character_flag = original_war_liege
			}
			log = "PlusFaction.205: SERIOUS: dying ruler had original_war_liege flag but wasn't a revolt leader: [This.GetTitledFirstName] of the [This.PrimaryTitle.GetFullBaseName] (ID: [This.GetID])"
			clr_character_flag = original_war_liege
		}

		# Handle the case where we're a revolt leader and need to potentially
		# pass on an original_war_liege flag
		liege_before_war = {
			any_war = {
				limit = {
					ROOT = { has_character_flag = is_revolt_leader_temp }
					defender = { character = PREVPREV }
					attacker = {
						character = ROOT
						has_opinion_modifier = { who = PREVPREV modifier = revolting_against }
						has_character_flag = original_war_liege
					}
				}
				ROOT = { current_heir = { set_character_flag = original_war_liege } }
			}
		}

		clr_character_flag = is_revolt_leader_temp

		if = {
			limit = { trait = rebel } # Are we a PF-style rebel?
			remove_trait = rebel

			if = {
				limit = { # Should we NOT pass down the revolt to our heir?
					NOT = {
						current_heir = {
							pf_war_trait_trigger = no
							pf_real_war_with_ROOT_trigger = no
						}
					}
				}

				current_heir = { # Sanity check
					if = {
						limit = {
							NAND = {
								is_playable = yes
								num_of_baron_titles = 1
							}
						}

						log = "PlusFaction.205: WARNING: character [This.GetTitledName] (ID: [This.GetID]), heir of [Root.GetTitledFirstName] of the [Root.PrimaryTitle.GetFullBaseName] (ID: [Root.GetID]), supposedly shouldn't inherit PF revolter status, but they are NOT EVEN A PLAYABLE RULER with at least 1 baron title!"

						if = {
							limit = { trait = rebel }
							log = "PlusFaction.205: they have the `rebel` trait"
						}
						if = {
							limit = { trait = loyalist }
							log = "PlusFaction.205: they have the `loyalist` trait"
						}
						if = {
							limit = { trait = neutral }
							log = "PlusFaction.205: they have the `neutral` trait"
						}
						if = {
							limit = { pf_real_war_with_ROOT_trigger = yes }
							log = "PlusFaction.205: they are on opposing sides of a war"
						}
					}
				}

				# If we're a revolt leader, then we can't pass down the revolt
				# to anyone in this case, so invalidate our PF-style revolts.

				liege_before_war = {
					any_war = {
						limit = {
							defender = { character = PREVPREV }
							attacker = {
								character = ROOT
								has_opinion_modifier = { who = PREVPREV modifier = revolting_against }
							}
						}
						defender = {
							log = "PlusFaction.205: INFO: dying ruler [Root.GetTitledFirstName] of the [Root.PrimaryTitle.GetFullBaseName] (ID: [Root.GetID]) is a revolt leader against [This.GetTitledFirstName] of the [This.PrimaryTitle.GetFullBaseName] (ID: [This.GetID]), but their heir cannot inherit the war, so the revolt must be invalidated"
						}
						end_war = invalid
						ROOT = { set_character_flag = invalidated_revolt_temp }
					}
				}

				if = {
					limit = {
						has_character_flag = invalidated_revolt_temp
						has_any_opinion_modifier = revolting_against
					}

					log = "PlusFaction.205: SERIOUS: former revolt leader [This.GetTitledFirstName] of the [This.PrimaryTitle.GetFullBaseName] (ID: [This.GetID]) still has at least one revolting_against TOM after invalidating his revolt; possibly check the CB's on_invalidation code, although it might be due to otherwise-incoherent TOM state; continuing anyway..."
				}

				clr_character_flag = invalidated_revolt_temp

				# Note that war invalidation will cleanup any revolting_against, etc. TOM state and such
				# by this point in the code if we were a revolt leader.

				# If we're not a revolt leader and we're a secondary revolt participant
				# (i.e., answered dynamic call-to-arms) in a PF revolt, revassalize
				# ourselves to the liege now, since our heir can't/shouldn't take our place.
				#
				# Likewise, if we're an ex-faction-member (not leader), part of the revolt
				# realm, also simply revassalize to the liege at this point, since our
				# heir shouldn't become a revolter.

				random_opinion_modifier_target = {
					limit = { reverse_has_opinion_modifier = { who = PREV modifier = revolting_against } }
					
					if = {
						limit = {
							any_war = { # Has to be a PF-style revolt by definition of revolting_against
								defender = { character = PREVPREV }
								any_attacker = { character = ROOT }
								attacker = { NOT = { character = ROOT } } # Should never happen due to war invalidation cleanup implied above
							}
						}

						log = "PlusFaction.205: INFO: dying ruler [Root.GetTitledFirstName] of the [Root.PrimaryTitle.GetFullBaseName] (ID: [Root.GetID]) is a 3rd-party revolter against [This.GetTitledFirstName] of the [This.PrimaryTitle.GetFullBaseName] (ID: [This.GetID]), but their heir cannot inherit the war, so they will be revassalized"
					}

					if = { # Note that this also catches revolt leaders if they somehow weren't handled previously
						limit = { # ... but they won't actually be able to be vassalized due to their revolt title's tier
							ROOT = {
								in_revolt = yes
								liege = {
									any_war = {
										attacker = { character = PREVPREV } # revolt leader
										defender = {
											reverse_has_opinion_modifier = { who = PREVPREV modifier = revolting_against }
											reverse_has_opinion_modifier = { who = ROOT modifier = revolting_against }
										}
									}
								}
							}
						}

						log = "PlusFaction.205: INFO: dying ruler [Root.GetTitledFirstName] of the [Root.PrimaryTitle.GetFullBaseName] (ID: [Root.GetID]) is a faction revolter against [This.GetTitledFirstName] of the [This.PrimaryTitle.GetFullBaseName] (ID: [This.GetID]), but their heir cannot inherit the war, so they will be revassalized"
					}

					set_defacto_vassal = ROOT

					if = {
						limit = { NOT = { is_vassal_or_below = ROOT } }

						log = "PlusFaction.205: SERIOUS: dying ruler [Root.GetTitledFirstName] of the [Root.PrimaryTitle.GetFullBaseName] (ID: [Root.GetID]) has an heir that cannot inherit their revolt, but revassalization somehow failed!"
					}

					reverse_remove_opinion = { who = PREV modifier = revolting_against }
					save_event_target_as = pf_was_revolting_against
				}

				if = {
					limit = { has_any_opinion_modifier = revolting_against }

					log = "PlusFaction.205: SERIOUS: multiple revolting_against TOMs for [Root.GetTitledFirstName] of the [Root.PrimaryTitle.GetFullBaseName] (ID: [Root.GetID])! remaining targets after removing TOM against [pf_was_revolting_against.GetTitledFirstName] of the [pf_was_revolting_against.PrimaryTitle.GetFullBaseName] (ID: [pf_was_revolting_against.GetID]):"
					
					any_opinion_modifier_target = {
						limit = { reverse_has_opinion_modifier = { who = PREV modifier = revolting_against } }
						log = "PlusFaction.205: --> [This.GetTitledFirstName] of the [This.PrimaryTitle.GetFullBaseName] (ID: [This.GetID])"
					}
				}

				clear_event_target = pf_was_revolting_against
			}

			if = {
				limit = { # Can we pass down the revolt to our heir?
					current_heir = {
						pf_war_trait_trigger = no
						pf_real_war_with_ROOT_trigger = no
					}
				}

				# Yes, we can pass it down.

				current_heir = { add_trait = rebel }

				random_opinion_modifier_target = { # Should only be one
					limit = { reverse_has_opinion_modifier = { who = PREV modifier = revolting_against } }
					ROOT = {
						current_heir = {
							if = {
								limit = { NOT = { has_opinion_modifier = { who = PREVPREV modifier = revolting_against } } }
								opinion = { who = PREVPREV modifier = revolting_against years = 100 }
							}
						}
					}
					reverse_remove_opinion = { who = PREV modifier = revolting_against }
					save_event_target_as = pf_was_revolting_against
				}

				if = {
					limit = { has_any_opinion_modifier = revolting_against }

					log = "PlusFaction.205: SERIOUS: heir will inherit multiple revolting_against TOMs from [This.GetTitledFirstName] of the [This.PrimaryTitle.GetFullBaseName] (ID: [This.GetID])! remaining targets after removing TOM against [pf_was_revolting_against.GetTitledFirstName] of the [pf_was_revolting_against.PrimaryTitle.GetFullBaseName] (ID: [pf_was_revolting_against.GetID]):"
					
					any_opinion_modifier_target = {
						limit = { reverse_has_opinion_modifier = { who = PREV modifier = revolting_against } }
						log = "PlusFaction.205: --> [This.GetTitledFirstName] of the [This.PrimaryTitle.GetFullBaseName] (ID: [This.GetID])"
						ROOT = {
							current_heir = {
								if = {
									limit = { NOT = { has_opinion_modifier = { who = PREVPREV modifier = revolting_against } } }
									opinion = { who = PREVPREV modifier = revolting_against years = 100 }
								}
							}
						}
					}
				}

				clear_event_target = pf_was_revolting_against
			}
		}
		
		# update civil war state of rebels who will now be rebelling against our heir
		# (i.e., those who are currently rebelling against *US*)

		# Liege change for the civil war
		any_war = {
			limit = {
				defender = { character = ROOT }
				attacker = { has_opinion_modifier = { who = ROOT modifier = revolting_against } }
			}
			attacker = { clr_character_flag = original_war_liege }
		}

		any_opinion_modifier_target = {
			limit = { reverse_has_opinion_modifier = { who = PREV modifier = revolting_against_me } }
			ROOT = {
				current_heir = {
					if = {
						limit = { NOT = { has_opinion_modifier = { who = PREVPREV modifier = revolting_against_me } } }
						opinion = { who = PREVPREV modifier = revolting_against_me years = 100 }
					}
					if = {
						limit = { NOT = { reverse_has_opinion_modifier = { who = PREVPREV modifier = revolting_against } } }
						reverse_opinion = { who = PREVPREV modifier = revolting_against years = 100 }
					}
				}
			}
		}
		any_opinion_modifier_target = {
			limit = { reverse_has_opinion_modifier = { who = PREV modifier = supported_civil_war } }
			ROOT = {
				current_heir = {
					if = {
						limit = { NOT = { has_opinion_modifier = { who = PREVPREV modifier = supported_civil_war } } }
						opinion = { who = PREVPREV modifier = supported_civil_war years = 100 }
					}
				}
			}
		}
		any_opinion_modifier_target = {
			limit = { reverse_has_opinion_modifier = { who = PREV modifier = neutral_civil_war } }
			ROOT = {
				current_heir = {
					if = {
						limit = { NOT = { has_opinion_modifier = { who = PREVPREV modifier = neutral_civil_war } } }
						opinion = { who = PREVPREV modifier = neutral_civil_war years = 100 }
					}
				}
			}
		}

		#reset heir's faction variables
		current_heir = {
			pf_reset_maintenance_vars_effect = yes
			clr_character_flag = faction_court_happy
			clr_character_flag = faction_court_unhappy
			clr_character_flag = faction_court_angry
			clr_character_flag = faction_prosperity_happy
			clr_character_flag = faction_prosperity_unhappy
			clr_character_flag = faction_prosperity_angry
			clr_character_flag = faction_glory_happy
			clr_character_flag = faction_glory_unhappy
			clr_character_flag = faction_glory_angry
			clr_character_flag = faction_tradition_happy
			clr_character_flag = faction_tradition_unhappy
			clr_character_flag = faction_tradition_angry
		}

		#pass on the liege's faction mood flags
		if = {
			limit = { has_character_flag = faction_court_happy }
			current_heir = { set_character_flag = faction_court_happy }
		}
		if = {
			limit = { has_character_flag = faction_court_unhappy }
			current_heir = { set_character_flag = faction_court_unhappy }
		}
		if = {
			limit = { has_character_flag = faction_court_angry }
			current_heir = { set_character_flag = faction_court_angry }
		}
		if = {
			limit = { has_character_flag = faction_prosperity_happy }
			current_heir = { set_character_flag = faction_prosperity_happy }
		}
		if = {
			limit = { has_character_flag = faction_prosperity_unhappy }
			current_heir = { set_character_flag = faction_prosperity_unhappy }
		}
		if = {
			limit = { has_character_flag = faction_prosperity_angry }
			current_heir = { set_character_flag = faction_prosperity_angry }
		}
		if = {
			limit = { has_character_flag = faction_glory_happy }
			current_heir = { set_character_flag = faction_glory_happy }
		}
		if = {
			limit = { has_character_flag = faction_glory_unhappy }
			current_heir = { set_character_flag = faction_glory_unhappy }
		}
		if = {
			limit = { has_character_flag = faction_glory_angry }
			current_heir = { set_character_flag = faction_glory_angry }
		}
		if = {
			limit = { has_character_flag = faction_tradition_happy }
			current_heir = { set_character_flag = faction_tradition_happy }
		}
		if = {
			limit = { has_character_flag = faction_tradition_unhappy }
			current_heir = { set_character_flag = faction_tradition_unhappy }
		}
		if = {
			limit = { has_character_flag = faction_tradition_angry }
			current_heir = { set_character_flag = faction_tradition_angry }
		}
	}
}

# Faction pleased due to title granted to one of their members
character_event = {
	id = PlusFaction.212

	is_triggered_only = yes
	hide_window = yes
	
	immediate = {
		#save the title and new holder as event targets
		FROM = {
			save_event_target_as = pf_new_title
			holder_scope = { save_event_target_as = pf_new_owner }
		}
		#claimants to the granted title who aren't close relatives of the new owner are displeased
		event_target:pf_new_title = {
			any_claimant = {
				limit = {
					NOR = {
						character = ROOT
						character = event_target:pf_new_owner
						is_close_relative = event_target:pf_new_owner
					}
					OR = {
						AND = {
							is_female = no
							ROOT = {
								succ_law_title = {
									NOT = { has_law = enatic_succession }
									NOT = { has_law = enatic_cognatic_succession }
								}
							}
						}
						AND = {
							is_female = yes
							ROOT = {
								succ_law_title = {
									NOT = { has_law = agnatic_succession }
									NOT = { has_law = cognatic_succession }
								}
							}
						}
					}
					any_liege = { character = ROOT }
				}
				if = {
					limit = { has_strong_claim = PREV }
					opinion = { who = ROOT modifier = faction_disapprove_title_grant multiplier = 4 years = 10 }
				}
				if = {
					limit = { has_weak_claim = PREV }
					opinion = { who = ROOT modifier = faction_disapprove_title_grant multiplier = 2 years = 10 }
				}
			}
		}
		#members of the same faction as the new holder are pleased, based on the tier of the title
		if = {
			limit = { event_target:pf_new_owner = { in_faction = faction_court } }
			ROOT = {
				any_vassal = {
					limit = {
						NOT = { character = event_target:pf_new_owner }
						in_faction = faction_court
					}
					if = {
						limit = { event_target:pf_new_title = { tier = BARON } }
						opinion = { who = ROOT modifier = faction_approve_title_grant years = 3 }
					}
					if = {
						limit = { event_target:pf_new_title = { tier = COUNT } }
						opinion = { who = ROOT modifier = faction_approve_title_grant multiplier = 2 years = 3 }
					}
					if = {
						limit = { event_target:pf_new_title = { tier = DUKE } }
						opinion = { who = ROOT modifier = faction_approve_title_grant multiplier = 4 years = 3 }
					}
					if = {
						limit = { event_target:pf_new_title = { tier = KING } }
						opinion = { who = ROOT modifier = faction_approve_title_grant multiplier = 6 years = 3 }
					}
				}
				character_event = { id = PlusFaction.200 days = 1 } #fire maintenance event to recalculate moods
			}
		}
		if = {
			limit = { event_target:pf_new_owner = { in_faction = faction_prosperity } }
			ROOT = {
				any_vassal = {
					limit = {
						NOT = { character = event_target:pf_new_owner }
						in_faction = faction_prosperity
					}
					if = {
						limit = { event_target:pf_new_title = { tier = BARON } }
						opinion = { who = ROOT modifier = faction_approve_title_grant years = 3 }
					}
					if = {
						limit = { event_target:pf_new_title = { tier = COUNT } }
						opinion = { who = ROOT modifier = faction_approve_title_grant multiplier = 2 years = 3 }
					}
					if = {
						limit = { event_target:pf_new_title = { tier = DUKE } }
						opinion = { who = ROOT modifier = faction_approve_title_grant multiplier = 4 years = 3 }
					}
					if = {
						limit = { event_target:pf_new_title = { tier = KING } }
						opinion = { who = ROOT modifier = faction_approve_title_grant multiplier = 6 years = 3 }
					}
				}
				character_event = { id = PlusFaction.200 days = 1 } #fire maintenance event to recalculate moods
			}
		}
		if = {
			limit = { event_target:pf_new_owner = { in_faction = faction_glory } }
			ROOT = {
				any_vassal = {
					limit = {
						NOT = { character = event_target:pf_new_owner }
						in_faction = faction_glory
					}
					if = {
						limit = { event_target:pf_new_title = { tier = BARON } }
						opinion = { who = ROOT modifier = faction_approve_title_grant years = 3 }
					}
					if = {
						limit = { event_target:pf_new_title = { tier = COUNT } }
						opinion = { who = ROOT modifier = faction_approve_title_grant multiplier = 2 years = 3 }
					}
					if = {
						limit = { event_target:pf_new_title = { tier = DUKE } }
						opinion = { who = ROOT modifier = faction_approve_title_grant multiplier = 4 years = 3 }
					}
					if = {
						limit = { event_target:pf_new_title = { tier = KING } }
						opinion = { who = ROOT modifier = faction_approve_title_grant multiplier = 6 years = 3 }
					}
				}
				character_event = { id = PlusFaction.200 days = 1 } #fire maintenance event to recalculate moods
			}
		}
		if = {
			limit = { event_target:pf_new_owner = { in_faction = faction_tradition } }
			ROOT = {
				any_vassal = {
					limit = {
						NOT = { character = event_target:pf_new_owner }
						in_faction = faction_tradition
					}
					if = {
						limit = { event_target:pf_new_title = { tier = BARON } }
						opinion = { who = ROOT modifier = faction_approve_title_grant years = 3 }
					}
					if = {
						limit = { event_target:pf_new_title = { tier = COUNT } }
						opinion = { who = ROOT modifier = faction_approve_title_grant multiplier = 2 years = 3 }
					}
					if = {
						limit = { event_target:pf_new_title = { tier = DUKE } }
						opinion = { who = ROOT modifier = faction_approve_title_grant multiplier = 4 years = 3 }
					}
					if = {
						limit = { event_target:pf_new_title = { tier = KING } }
						opinion = { who = ROOT modifier = faction_approve_title_grant multiplier = 6 years = 3 }
					}
				}
				character_event = { id = PlusFaction.200 days = 1 } #fire maintenance event to recalculate moods
			}
		}
	}
}

# Annual faction maintenance event <MTTH>
#
# This needs to be a separate event from PlusFaction.200 so that it may use an
# optimized pre-trigger. If we tried making one event double as both, we'd either
# have to use no such pre-trigger, or we'd always have to set the `pf_pulse` flag
# for each triggered invocation of PlusFaction.200 or else we'd drop those events
# on the floor due to failing the common pre-trigger.
#
# Hence, we've separate events that use the same common code (setup + tear-down)
# to avoid duplication, factored-out into the minimum 2 common possible "stages"
# (setup --> <non-common stuff> --> completion).

character_event = {
	id = PlusFaction.220

	hide_window = yes

	only_playable = yes
	has_character_flag = pf_pulse
	
	trigger = {
		higher_tier_than = COUNT
		is_nomadic = no
		is_landed = yes
		any_vassal = { pf_member_trigger = yes }
	}

	# NOTE: Intentionally no MTTH clause, should deterministically always trigger
	# upon this character's EVENT_PROCESS_OFFSET slot (a game day since start
	# that is the sum of a randomized-per-character static "offset",
	# between 1 and EVENT_PROCESS_OFFSET and an EVENT_PROCESS_OFFSET multiple):
	#
	# Game day since scenario start that I run on without the pf_pulse pre-trigger[*]:
	# DAY = <static per-character slot offset> + EVENT_PROCESS_OFFSET * N,
	# where N is the Nth MTTH eval/exec period. Since we only trigger when `pf_pulse`
	# is set here and then clear `pf_pulse` immediately, we skip
	# (365/EVENT_PROCESS_OFFSET)-1 MTTH eval/exec periods between annual maintenance
	# invocations on average (17.25 skips/year if E_P_O == 20 and 1 invocation/year).
	#
	# [*] This is an ideal model; the per-character slot-offset can change IRL
	# as the engine trys to rebalance characters uniformly over [1, EVENT_PROCESS_OFFSET].
	# This can periodically introduce minor jitter bounded by EVENT_PROCESS_OFFSET
	# as that "constant day slot offset" is changed for a character, IF the engine
	# ever even tries to rebalance its living characters over [1, EVENT_PROCESS_OFFSET],
	# which is a big IF. Otherwise, it is actually the ideal model. IF the engine
	# does do this, it'd only be once every several game years, from my experience.
	#
	# ^-- All of the above applies to any MTTH scheduling when the "probability"
	# component is removed by NOT having an MTTH factor clause. These are effectively
	# EVENT_PROCESS_OFFSET-pulse events, except more accurate than any type of
	# on_action pulse.
	#
	# TL;DR: This is a nitty-gritty way to get an on_yearly_pulse on_action that
	# is highly-accurate with a worst-case error of EVENT_PROCESS_OFFSET-1 days.

	immediate = {
		clr_character_flag = pf_pulse

		character_event = { id = PlusFaction.221 } # setup effects

		#remove any [invalid] faction_mood increase/decrease on non-faction-leaders
		if = {
			limit = {
				pf_leader_trigger = no
				OR = {
					check_variable = { which = "faction_mood_increase" value = 0.1 }
					check_variable = { which = "faction_mood_decrease" value = 0.1 }
				}
			}
			set_variable = { which = "faction_mood_increase" value = 0 }
			set_variable = { which = "faction_mood_decrease" value = 0 }
		}
		any_vassal = {
			limit = {
				pf_leader_trigger = no
				OR = {
					check_variable = { which = "faction_mood_increase" value = 0.1 }
					check_variable = { which = "faction_mood_decrease" value = 0.1 }
				}
			}
			set_variable = { which = "faction_mood_increase" value = 0 }
			set_variable = { which = "faction_mood_decrease" value = 0 }
		}

		# In the future, we will support execution of deferred faction mood impulse
		# maintenance here: ---->   <------

		## ANNUAL MAINTENANCE CORE ##

		# Crown Authority
		any_vassal = {
			# x2 to prevent all "leftover" stacking
			remove_opinion = { who = ROOT modifier = faction_approve_CA }
			remove_opinion = { who = ROOT modifier = faction_approve_CA }

			# x5 to prevent all "leftover" stacking
			remove_opinion = { who = ROOT modifier = faction_disapprove_CA }
			remove_opinion = { who = ROOT modifier = faction_disapprove_CA }
			remove_opinion = { who = ROOT modifier = faction_disapprove_CA }
			remove_opinion = { who = ROOT modifier = faction_disapprove_CA }
			remove_opinion = { who = ROOT modifier = faction_disapprove_CA }
		}
		if = {
			limit = {
				is_tribal = no
				is_nomadic = no # For completeness only
				any_demesne_title = { is_crown_law_title = yes }
			}
			#court faction disapproves the most of high CA, with court factions in the HRE being even more extreme
			any_vassal = {
				limit = { in_faction = faction_court }
				if = {
					limit = { crownlaw_title = { holder = ROOT has_law = crown_authority_0 } }
					opinion = { who = ROOT modifier = faction_approve_CA months = 14 }
				}
				if = {
					limit = {
						ROOT = { NOT = { has_landed_title = e_hre } }
						crownlaw_title = { holder = ROOT has_law = crown_authority_1 }
					}
					opinion = { who = ROOT modifier = faction_disapprove_CA months = 14 }
				}
				if = {
					limit = {
						ROOT = { has_landed_title = e_hre }
						crownlaw_title = { holder = ROOT has_law = crown_authority_1 }
					}
					opinion = { who = ROOT modifier = faction_disapprove_CA multiplier = 2 months = 14 }
				}
				if = {
					limit = {
						ROOT = { NOT = { has_landed_title = e_hre } }
						crownlaw_title = { holder = ROOT has_law = crown_authority_2 }
					}
					opinion = { who = ROOT modifier = faction_disapprove_CA months = 14 }
				}
				if = {
					limit = {
						ROOT = { has_landed_title = e_hre }
						crownlaw_title = { holder = ROOT has_law = crown_authority_2 }
					}
					opinion = { who = ROOT modifier = faction_disapprove_CA multiplier = 3 months = 14 }
				}
				if = {
					limit = {
						ROOT = { NOT = { has_landed_title = e_hre } }
						crownlaw_title = { holder = ROOT has_law = crown_authority_3 }
					}
					opinion = { who = ROOT modifier = faction_disapprove_CA multiplier = 2 months = 14 }
				}
				if = {
					limit = {
						ROOT = { has_landed_title = e_hre }
						crownlaw_title = { holder = ROOT has_law = crown_authority_3 }
					}
					opinion = { who = ROOT modifier = faction_disapprove_CA multiplier = 4 months = 14 }
				}
				if = {
					limit = {
						ROOT = { NOT = { has_landed_title = e_hre } }
						crownlaw_title = { holder = ROOT has_law = crown_authority_4 }
					}
					opinion = { who = ROOT modifier = faction_disapprove_CA multiplier = 3 months = 14 }
				}
				if = {
					limit = {
						ROOT = { has_landed_title = e_hre }
						crownlaw_title = { holder = ROOT has_law = crown_authority_4 }
					}
					opinion = { who = ROOT modifier = faction_disapprove_CA multiplier = 5 months = 14 }
				}
			}
			#prosperity faction approves of high CA (more order in the kingdom)
			any_vassal = {
				limit = { in_faction = faction_prosperity }
				if = {
					limit = { crownlaw_title = { holder = ROOT has_law = crown_authority_0 } }
					opinion = { who = ROOT modifier = faction_disapprove_CA months = 14 }
				}
				if = {
					limit = { crownlaw_title = { holder = ROOT has_law = crown_authority_3 } }
					opinion = { who = ROOT modifier = faction_approve_CA months = 14 }
				}
				if = {
					limit = { crownlaw_title = { holder = ROOT has_law = crown_authority_4 } }
					opinion = { who = ROOT modifier = faction_approve_CA multiplier = 2 months = 14 }
				}
			}
			#glory and tradition factions disapprove of high CA, but only in the HRE
			any_vassal = {
				limit = {
					ROOT = { has_landed_title = e_hre }
					OR = {
						in_faction = faction_glory
						in_faction = faction_tradition
					}
				}
				if = {
					limit = { crownlaw_title = { holder = ROOT has_law = crown_authority_2 } }
					opinion = { who = ROOT modifier = faction_disapprove_CA months = 14 }
				}
				if = {
					limit = { crownlaw_title = { holder = ROOT has_law = crown_authority_3 } }
					opinion = { who = ROOT modifier = faction_disapprove_CA multiplier = 2 months = 14 }
				}
				if = {
					limit = { crownlaw_title = { holder = ROOT has_law = crown_authority_4 } }
					opinion = { who = ROOT modifier = faction_disapprove_CA multiplier = 3 months = 14 }
				}
			}
		}

		#TRIBAL ORGANIZATION
		any_vassal = {
			# x2 to remove all possible "leftover" stacking
			remove_opinion = { who = ROOT modifier = faction_approve_TO }
			remove_opinion = { who = ROOT modifier = faction_approve_TO }

			# x3 to remove all possible "leftover" stacking
			remove_opinion = { who = ROOT modifier = faction_disapprove_TO }
			remove_opinion = { who = ROOT modifier = faction_disapprove_TO }
			remove_opinion = { who = ROOT modifier = faction_disapprove_TO }
		}
		if = {
			limit = { is_tribal = yes }
			#Tribal Organization 0
			if = {
				limit = { has_law = tribal_organization_0 }
				#court factions approve
				any_vassal = {
					limit = { in_faction = faction_court }
					opinion = { who = ROOT modifier = faction_approve_TO months = 14 }
				}
				#prosperity factions disapprove
				any_vassal = {
					limit = { in_faction = faction_prosperity }
					opinion = { who = ROOT modifier = faction_disapprove_TO months = 14 }
				}
			}
			#Tribal Organization 1
			if = {
				limit = { has_law = tribal_organization_1 }
				#court factions disapprove
				any_vassal = {
					limit = { in_faction = faction_court }
					opinion = { who = ROOT modifier = faction_disapprove_TO months = 14 }
				}
			}
			#Tribal Organization 2
			if = {
				limit = { has_law = tribal_organization_2 }
				# court factions disapprove
				any_vassal = {
					limit = { in_faction = faction_court }
					opinion = { who = ROOT modifier = faction_disapprove_TO months = 14 }
				}
			}
			#Tribal Organization 3
			if = {
				limit = { has_law = tribal_organization_3 }
				# court factions really disapprove
				any_vassal = {
					limit = { in_faction = faction_court }
					opinion = { who = ROOT modifier = faction_disapprove_TO multiplier = 2 months = 14 }
				}
				# tradition factions disapprove
				any_vassal = {
					limit = { in_faction = faction_tradition }
					opinion = { who = ROOT modifier = faction_disapprove_TO months = 14 }
				}
				# prosperity factions approve
				any_vassal = {
					limit = { in_faction = faction_prosperity }
					opinion = { who = ROOT modifier = faction_approve_TO months = 14 }
				}
			}
			#Tribal Organization 4
			if = {
				limit = { has_law = tribal_organization_4 }
				#court factions really disapprove
				any_vassal = {
					limit = { in_faction = faction_court }
					opinion = { who = ROOT modifier = faction_disapprove_TO multiplier = 3 months = 14 }
				}
				#tradition factions disapprove
				any_vassal = {
					limit = { in_faction = faction_tradition }
					opinion = { who = ROOT modifier = faction_disapprove_TO months = 14 }
				}
				#prosperity factions really approve
				any_vassal = {
					limit = { in_faction = faction_prosperity }
					opinion = { who = ROOT modifier = faction_approve_TO multiplier = 2 months = 14 }
				}
			}
		}

		#OBLIGATIONS
		any_vassal = {
			remove_opinion = { who = ROOT modifier = faction_approve_obligations }

			# Max. stacking for faction_disapprove_obligations:
			#
			# ================================================
			# FACTION | FEUDAL/IQTA | TEMPLE | CITY | TRIBAL |
			# --------+-------------+--------+------+--------+
			# court   |           3 |      0 |    0 |      3 | => 6
			# prosper |           1 |      1 |    3 |      1 | => 6
			# glory   |           2 |      0 |    0 |      2 | => 4
			# traditi |           0 |      3 |    0 |      0 | => 3
			# =================================================+
			#
			# Ergo, ergo court & prosperity can stack the highest with 6
			#
			# x6 to remove all possible "leftover" stacking
			remove_opinion = { who = ROOT modifier = faction_disapprove_obligations }
			remove_opinion = { who = ROOT modifier = faction_disapprove_obligations }
			remove_opinion = { who = ROOT modifier = faction_disapprove_obligations }
			remove_opinion = { who = ROOT modifier = faction_disapprove_obligations }
			remove_opinion = { who = ROOT modifier = faction_disapprove_obligations }
			remove_opinion = { who = ROOT modifier = faction_disapprove_obligations }
		}
		#Feudal Obligations 0
		if = {
			limit = { has_law = feudal_obligations_0 }
			any_vassal = {
				limit = {
					OR = {
						in_faction = faction_court
						in_faction = faction_glory
					}
				}
				opinion = { who = ROOT modifier = faction_approve_obligations months = 14 }
			}
		}
		#Feudal Obligations 2
		if = {
			limit = { has_law = feudal_obligations_2 }
			any_vassal = {
				limit = { in_faction = faction_court }
				opinion = { who = ROOT modifier = faction_disapprove_obligations months = 14 }
			}
		}
		#Feudal Obligations 3
		if = {
			limit = { has_law = feudal_obligations_3 }
			any_vassal = {
				limit = { in_faction = faction_court }
				opinion = { who = ROOT modifier = faction_disapprove_obligations multiplier = 2 months = 14 }
			}
			any_vassal = {
				limit = { in_faction = faction_glory }
				opinion = { who = ROOT modifier = faction_disapprove_obligations months = 14 }
			}
		}
		#Feudal Obligations 4
		if = {
			limit = { has_law = feudal_obligations_4 }
			any_vassal = {
				limit = { in_faction = faction_court }
				opinion = { who = ROOT modifier = faction_disapprove_obligations multiplier = 3 months = 14 }
			}
			any_vassal = {
				limit = { in_faction = faction_glory }
				opinion = { who = ROOT modifier = faction_disapprove_obligations multiplier = 2 months = 14 }
			}
			any_vassal = {
				limit = { in_faction = faction_prosperity }
				opinion = { who = ROOT modifier = faction_disapprove_obligations months = 14 }
			}
		}			
		#Temple Obligations 0
		if = {
			limit = { has_law = temple_obligations_0 }
			any_vassal = {
				limit = { in_faction = faction_tradition }
				opinion = { who = ROOT modifier = faction_approve_obligations months = 14 }
			}
		}
		#Temple Obligations 2
		if = {
			limit = { has_law = temple_obligations_2 }
			any_vassal = {
				limit = { in_faction = faction_tradition }
				opinion = { who = ROOT modifier = faction_disapprove_obligations months = 14 }
			}
		}
		#Temple Obligations 3
		if = {
			limit = { has_law = temple_obligations_3 }
			any_vassal = {
				limit = { in_faction = faction_tradition }
				opinion = { who = ROOT modifier = faction_disapprove_obligations multiplier = 2 months = 14 }
			}
		}
		#Temple Obligations 4
		if = {
			limit = { has_law = temple_obligations_4 }
			any_vassal = {
				limit = { in_faction = faction_tradition }
				opinion = { who = ROOT modifier = faction_disapprove_obligations multiplier = 3 months = 14 }
			}
			any_vassal = {
				limit = { in_faction = faction_prosperity }
				opinion = { who = ROOT modifier = faction_disapprove_obligations months = 14 }
			}
		}
		#City Obligations 0
		if = {
			limit = { has_law = city_obligations_0 }
			any_vassal = {
				limit = { in_faction = faction_prosperity }
				opinion = { who = ROOT modifier = faction_approve_obligations months = 14 }
			}
		}
		#City Obligations 2
		if = {
			limit = { has_law = city_obligations_2 }
			any_vassal = {
				limit = { in_faction = faction_prosperity }
				opinion = { who = ROOT modifier = faction_disapprove_obligations months = 14 }
			}
		}
		#City Obligations 3
		if = {
			limit = { has_law = city_obligations_3 }
			any_vassal = {
				limit = { in_faction = faction_prosperity }
				opinion = { who = ROOT modifier = faction_disapprove_obligations multiplier = 2 months = 14 }
			}
		}
		#City Obligations 4
		if = {
			limit = { has_law = city_obligations_4 }
			any_vassal = {
				limit = { in_faction = faction_prosperity }
				opinion = { who = ROOT modifier = faction_disapprove_obligations multiplier = 3 months = 14 }
			}
		}
		#Iqta Obligations 0
		if = {
			limit = { has_law = iqta_obligations_0 }
			any_vassal = {
				limit = {
					OR = {
						in_faction = faction_court
						in_faction = faction_glory
					}
				}
				opinion = { who = ROOT modifier = faction_approve_obligations months = 14 }
			}
		}
		#Iqta Obligations 2
		if = {
			limit = { has_law = iqta_obligations_2 }
			any_vassal = {
				limit = { in_faction = faction_court }
				opinion = { who = ROOT modifier = faction_disapprove_obligations months = 14 }
			}
		}
		#Iqta Obligations 3
		if = {
			limit = { has_law = iqta_obligations_3 }
			any_vassal = {
				limit = { in_faction = faction_court }
				opinion = { who = ROOT modifier = faction_disapprove_obligations multiplier = 2 months = 14 }
			}
			any_vassal = {
				limit = { in_faction = faction_glory }
				opinion = { who = ROOT modifier = faction_disapprove_obligations months = 14 }
			}
		}
		#Iqta Obligations 4
		if = {
			limit = { has_law = iqta_obligations_4 }
			any_vassal = {
				limit = { in_faction = faction_court }
				opinion = { who = ROOT modifier = faction_disapprove_obligations multiplier = 3 months = 14 }
			}
			any_vassal = {
				limit = { in_faction = faction_glory }
				opinion = { who = ROOT modifier = faction_disapprove_obligations multiplier = 2 months = 14 }
			}
			any_vassal = {
				limit = { in_faction = faction_prosperity }
				opinion = { who = ROOT modifier = faction_disapprove_obligations months = 14 }
			}
		}
		#Tribal Obligations 0
		if = {
			limit = { has_law = tribal_obligations_0 }
			any_vassal = {
				limit = {
					is_tribal = yes
					OR = {
						in_faction = faction_court
						in_faction = faction_glory
					}
				}
				opinion = { who = ROOT modifier = faction_approve_obligations months = 14 }
			}
		}
		#Tribal Obligations 2
		if = {
			limit = { has_law = tribal_obligations_2 }
			any_vassal = {
				limit = {
					is_tribal = yes
					in_faction = faction_court
				}
				opinion = { who = ROOT modifier = faction_disapprove_obligations months = 14 }
			}
		}
		#Tribal Obligations 3
		if = {
			limit = { has_law = tribal_obligations_3 }
			any_vassal = {
				limit = {
					is_tribal = yes
					in_faction = faction_court
				}
				opinion = { who = ROOT modifier = faction_disapprove_obligations multiplier = 2 months = 14 }
			}
			any_vassal = {
				limit = {
					is_tribal = yes
					in_faction = faction_glory
				}
				opinion = { who = ROOT modifier = faction_disapprove_obligations months = 14 }
			}
		}
		#Tribal Obligations 4
		if = {
			limit = { has_law = tribal_obligations_4 }
			any_vassal = {
				limit = {
					is_tribal = yes
					in_faction = faction_court
				}
				opinion = { who = ROOT modifier = faction_disapprove_obligations multiplier = 3 months = 14 }
			}
			any_vassal = {
				limit = {
					is_tribal = yes
					in_faction = faction_glory
				}
				opinion = { who = ROOT modifier = faction_disapprove_obligations multiplier = 2 months = 14 }
			}
			any_vassal = {
				limit = {
					is_tribal = yes
					in_faction = faction_prosperity
				}
				opinion = { who = ROOT modifier = faction_disapprove_obligations months = 14 }
			}
		}

		#COUNCIL TERMS
		any_vassal = {
			remove_opinion = { who = ROOT modifier = faction_approve_council_term }
		}
		if = {
			limit = { has_law = council_privileges_1 }
			job_chancellor = {
				remove_opinion = { who = ROOT modifier = grateful_council_term }
				opinion = { who = ROOT modifier = grateful_council_term months = 14 }
			}
			job_marshal = {
				remove_opinion = { who = ROOT modifier = grateful_council_term }
				opinion = { who = ROOT modifier = grateful_council_term months = 14 }
			}
			job_treasurer = {
				remove_opinion = { who = ROOT modifier = grateful_council_term }
				opinion = { who = ROOT modifier = grateful_council_term months = 14 }
			}
			job_spymaster = {
				remove_opinion = { who = ROOT modifier = grateful_council_term }
				opinion = { who = ROOT modifier = grateful_council_term months = 14 }
			}
			job_spiritual = {
				remove_opinion = { who = ROOT modifier = grateful_council_term }
				opinion = { who = ROOT modifier = grateful_council_term months = 14 }
			}
			any_vassal = {
				limit = { in_faction = faction_tradition }
				opinion = { who = ROOT modifier = faction_approve_council_term months = 14 }
			}
		}
		
		#COUNCILLORS
		any_vassal = {
			remove_opinion = { who = ROOT modifier = faction_approve_council }
			remove_opinion = { who = ROOT modifier = faction_disapprove_council }
		}
		#No Court Faction member on council
		if = {
			limit = { pf_councillor_court_trigger = no }
			any_vassal = {
				limit = {
					is_councillor = no
					in_faction = faction_court
				}
				opinion = { who = ROOT modifier = faction_disapprove_council months = 14 }
			}
		}
		#Court Faction member on council
		if = {
			limit = { pf_councillor_court_trigger = yes }
			any_vassal = {
				limit = { in_faction = faction_court }
				opinion = { who = ROOT modifier = faction_approve_council months = 14 }
			}
		}
		#Steward is NOT member of Prosperity Faction
		if = {
			limit = { pf_councillor_prosperity_trigger = no }
			any_vassal = {
				limit = {
					is_councillor = no
					in_faction = faction_prosperity
				}
				opinion = { who = ROOT modifier = faction_disapprove_council months = 14 }
			}
		}
		#Steward is member of Prosperity Faction
		if = {
			limit = { pf_councillor_prosperity_trigger = yes }
			any_vassal = {
				limit = { in_faction = faction_prosperity }
				opinion = { who = ROOT modifier = faction_approve_council months = 14 }
			}
		}
		#Marshal is NOT member of Glory Faction
		if = {
			limit = { pf_councillor_glory_trigger = no }
			any_vassal = {
				limit = {
					is_councillor = no
					in_faction = faction_glory
				}
				opinion = { who = ROOT modifier = faction_disapprove_council months = 14 }
			}
		}
		#Marshal is member of Glory Faction
		if = {
			limit = { pf_councillor_glory_trigger = yes }
			any_vassal = {
				limit = { in_faction = faction_glory }
				opinion = { who = ROOT modifier = faction_approve_council months = 14 }
			}
		}
		#Lord Spiritual is NOT member of Tradition Faction
		if = {
			limit = { pf_councillor_tradition_trigger = no }
			any_vassal = {
				limit = {
					is_councillor = no
					in_faction = faction_tradition
				}
				opinion = { who = ROOT modifier = faction_disapprove_council months = 14 }
			}
		}
		#Lord Spiritual is member of Tradition Faction
		if = {
			limit = { pf_councillor_tradition_trigger = yes }
			any_vassal = {
				limit = { in_faction = faction_tradition }
				opinion = { who = ROOT modifier = faction_approve_council months = 14 }
			}
		}

		#LIEGE PIETY
		any_vassal = {
			# x4 to prevent all "leftover" stacking
			remove_opinion = { who = ROOT modifier = faction_approve_piety }
			remove_opinion = { who = ROOT modifier = faction_approve_piety }
			remove_opinion = { who = ROOT modifier = faction_approve_piety }
			remove_opinion = { who = ROOT modifier = faction_approve_piety }
			# x4 to prevent all "leftover" stacking
			remove_opinion = { who = ROOT modifier = faction_disapprove_piety }
			remove_opinion = { who = ROOT modifier = faction_disapprove_piety }
			remove_opinion = { who = ROOT modifier = faction_disapprove_piety }
			remove_opinion = { who = ROOT modifier = faction_disapprove_piety }
		}
		#Liege has negative piety and NOT in a crusade or holy war
		if = {
			limit = {
				NOR = {
					piety = 0
					pf_tradition_approved_war_trigger = yes
				}
			}
			#Non-muslim Tradition Faction disapproves
			any_vassal = {
				limit = {
					NOT = { religion_group = muslim }
					in_faction = faction_tradition
				}
				opinion = { who = ROOT modifier = faction_disapprove_piety multiplier = 2 months = 14 }
			}
			#Muslim Tradition Faction disapproves more
			any_vassal = {
				limit = {
					religion_group = muslim
					in_faction = faction_tradition
				}
				opinion = { who = ROOT modifier = faction_disapprove_piety multiplier = 4 months = 14 }
			}
			#Muslim Court Faction disapproves
			any_vassal = {
				limit = {
					religion_group = muslim
					in_faction = faction_court
				}
				opinion = { who = ROOT modifier = faction_disapprove_piety multiplier = 2 months = 14 }
			}
			#Muslim Glory Faction disapproves less
			any_vassal = {
				limit = {
					religion_group = muslim
					in_faction = faction_glory
				}
				opinion = { who = ROOT modifier = faction_disapprove_piety months = 14 }
			}
		}
		#Liege has 500-999 Piety
		if = {
			limit = {
				piety = 500
				NOT = { piety = 1000 }
			}
			#Tradition Faction approves
			any_vassal = {
				limit = { in_faction = faction_tradition }
				opinion = { who = ROOT modifier = faction_approve_piety months = 14 }
			}
		}
		#Liege has 1000+ Piety
		if = {
			limit = { piety = 1000 }
			#Tradition Faction approves more
			any_vassal = {
				limit = { in_faction = faction_tradition }
				opinion = { who = ROOT modifier = faction_approve_piety multiplier = 2 months = 14 }
			}
		}
		#Liege is in a crusade or holy war
		if = {
			limit = { pf_tradition_approved_war_trigger = yes }
			#Tradition Faction approves more
			any_vassal = {
				limit = { in_faction = faction_tradition }
				opinion = { who = ROOT modifier = faction_approve_piety multiplier = 2 months = 14 }
			}
		}

		#LIEGE DEBT/WEALTH
		any_vassal = {
			remove_opinion = { who = ROOT modifier = faction_disapprove_debt }
			remove_opinion = { who = ROOT modifier = faction_approve_wealth }
		}
		#Liege has negative wealth or is in debt
		if = {
			limit = {
				OR = {
					NOT = { wealth = 0 }
					has_character_flag = loan_taken
					check_variable = { which = "loan_amount" value = 49.5 }
				}
			}
			#Prosperity faction disapproves
			any_vassal = {
				limit = { in_faction = faction_prosperity }
				opinion = { who = ROOT modifier = faction_disapprove_debt multiplier = 2 months = 14 }
			}
		}
		#Liege has 2.5-4.9 scaled wealth, and no loan
		if = {
			limit = {
				scaled_wealth = 2.5
				NOT = { scaled_wealth = 5.0 }
				NOT = { has_character_flag = loan_taken }
				NOT = { check_variable = { which = "loan_amount" value = 49.5 } }
			}
			#Prosperity faction approves
			any_vassal = {
				limit = { in_faction = faction_prosperity }
				opinion = { who = ROOT modifier = faction_approve_wealth months = 14 }
			}
		}
		#Liege has 5.0+ scaled wealth, and no loan
		if = {
			limit = {
				scaled_wealth = 5.0
				NOT = { has_character_flag = loan_taken }
				NOT = { check_variable = { which = "loan_amount" value = 49.5 } }
			}
			#Prosperity faction approves more
			any_vassal = {
				limit = { in_faction = faction_prosperity }
				opinion = { who = ROOT modifier = faction_approve_wealth multiplier = 2 months = 14 }
			}
		}

		#LIEGE PRESTIGE
		any_vassal = {
			# x2 to prevent all "leftover" stacking
			remove_opinion = { who = ROOT modifier = faction_approve_prestige }
			remove_opinion = { who = ROOT modifier = faction_approve_prestige }
			remove_opinion = { who = ROOT modifier = faction_disapprove_prestige }
			remove_opinion = { who = ROOT modifier = faction_disapprove_prestige }
		}
		#Liege has negative prestige
		if = {
			limit = { NOT = { prestige = 0 } }
			#Glory Faction disapproves
			any_vassal = {
				limit = { in_faction = faction_glory }
				opinion = { who = ROOT modifier = faction_disapprove_prestige multiplier = 2 months = 14 }
			}
		}
		#Liege has 1000-2499 Prestige
		if = {
			limit = {
				prestige = 1000
				NOT = { prestige = 2500 }
			}
			#Glory Faction approves
			any_vassal = {
				limit = { in_faction = faction_glory }
				opinion = { who = ROOT modifier = faction_approve_prestige months = 14 }
			}
		}
		#Liege has 2500 Prestige+
		if = {
			limit = {
				prestige = 2500
			}
			#Glory Faction approves more
			any_vassal = {
				limit = { in_faction = faction_glory }
				opinion = { who = ROOT modifier = faction_approve_prestige multiplier = 2 months = 14 }
			}
		}

		#YEARS OF PEACE
		any_vassal = {
			# x4 to remove max. possible stacked modifiers
			remove_opinion = { who = ROOT modifier = faction_approve_peace }
			remove_opinion = { who = ROOT modifier = faction_approve_peace }
			remove_opinion = { who = ROOT modifier = faction_approve_peace }
			remove_opinion = { who = ROOT modifier = faction_approve_peace }
			remove_opinion = { who = ROOT modifier = faction_disapprove_peace }
			remove_opinion = { who = ROOT modifier = faction_disapprove_peace }
			remove_opinion = { who = ROOT modifier = faction_disapprove_peace }
			remove_opinion = { who = ROOT modifier = faction_disapprove_peace }
		}
		#5-10 years of consecutive peace
		if = {
			limit = {
				check_variable = { which = "years_of_peace" value = 5 }
				NOT = { check_variable = { which = "years_of_peace" value = 10 } }
			}
			#Prosperity Faction approves
			any_vassal = {
				limit = { in_faction = faction_prosperity }
				opinion = { who = ROOT modifier = faction_approve_peace months = 14 }
			}
			#Glory Faction disapproves
			any_vassal = {
				limit = { in_faction = faction_glory }
				opinion = { who = ROOT modifier = faction_disapprove_peace months = 14 }
			}
		}
		#10-15 years of consecutive peace
		if = {
			limit = {
				check_variable = { which = "years_of_peace" value = 10 }
				NOT = { check_variable = { which = "years_of_peace" value = 15 } }
			}
			#Prosperity Faction approves more
			any_vassal = {
				limit = { in_faction = faction_prosperity }
				opinion = { who = ROOT modifier = faction_approve_peace multiplier = 2 months = 14 }
			}
			#Glory Faction disapproves more
			any_vassal = {
				limit = { in_faction = faction_glory }
				opinion = { who = ROOT modifier = faction_disapprove_peace multiplier = 2 months = 14 }
			}
		}
		#15-20 years of consecutive peace
		if = {
			limit = {
				check_variable = { which = "years_of_peace" value = 15 }
				NOT = { check_variable = { which = "years_of_peace" value = 20 } }
			}
			#Prosperity Faction approves more & more
			any_vassal = {
				limit = { in_faction = faction_prosperity }
				opinion = { who = ROOT modifier = faction_approve_peace multiplier = 3 months = 14 }
			}
			#Glory Faction disapproves more & more
			any_vassal = {
				limit = { in_faction = faction_glory }
				opinion = { who = ROOT modifier = faction_disapprove_peace multiplier = 3 months = 14 }
			}
		}
		#20+ years of consecutive peace
		if = {
			limit = {
				check_variable = { which = "years_of_peace" value = 20 }
			}
			#Prosperity Faction REALLY approves
			any_vassal = {
				limit = { in_faction = faction_prosperity }
				opinion = { who = ROOT modifier = faction_approve_peace multiplier = 4 months = 14 }
			}
			#Glory Faction REALLY disapproves
			any_vassal = {
				limit = { in_faction = faction_glory }
				opinion = { who = ROOT modifier = faction_disapprove_peace multiplier = 4 months = 14 }
			}
		}

		#Adjust moods of factions towards their own leaders, based on agreement over opinion of liege
		any_vassal = {
			limit = { pf_leader_trigger = yes }
			#First remove the old agree/disagree modifiers for all the liege's vassals
			ROOT = {
				any_vassal = {
					remove_opinion = { who = PREVPREV modifier = faction_agree_liege }
					# x3 to prevent all "leftover" stacking
					remove_opinion = { who = PREVPREV modifier = faction_disagree_liege }
					remove_opinion = { who = PREVPREV modifier = faction_disagree_liege }
					remove_opinion = { who = PREVPREV modifier = faction_disagree_liege }
				}
			}
			#Then check the faction leader's opinion range of the liege
			#and look at all fellow faction members, and see if they sit in the same range or NOT
			#the more extreme the difference, the larger the disapproval of the faction leader
			if = {
				limit = {
					NOT = { opinion = { who = ROOT value = -75 } }
				}
				any_faction_backer = {
					limit = { pf_my_faction_backer_trigger = yes }
					if = {
						limit = {
							NOT = { opinion = { who = ROOT value = -75 } }
						}
						opinion = { who = PREV modifier = faction_agree_liege months = 14 }
					}
					if = {
						limit = {
							opinion = { who = ROOT value = -25 }
							NOT = { opinion = { who = ROOT value = 25 } }
						}
						opinion = { who = PREV modifier = faction_disagree_liege months = 14 }
					}
					if = {
						limit = {
							opinion = { who = ROOT value = 25 }
							NOT = { opinion = { who = ROOT value = 75 } }
						}
						opinion = { who = PREV modifier = faction_disagree_liege multiplier = 2 months = 14 }
					}
					if = {
						limit = {
							opinion = { who = ROOT value = 75 }
						}
						opinion = { who = PREV modifier = faction_disagree_liege multiplier = 3 months = 14 }
					}
				}
			}
			if = {
				limit = {
					opinion = { who = ROOT value = -75 }
					NOT = { opinion = { who = ROOT value = -25 } }
				}
				any_faction_backer = {
					limit = { pf_my_faction_backer_trigger = yes }
					if = {
						limit = {
							opinion = { who = ROOT value = -75 }
							NOT = { opinion = { who = ROOT value = -25 } }
						}
						opinion = { who = PREV modifier = faction_agree_liege months = 14 }
					}
					if = {
						limit = {
							opinion = { who = ROOT value = 25 }
							NOT = { opinion = { who = ROOT value = 75 } }
						}
						opinion = { who = PREV modifier = faction_disagree_liege months = 14 }
					}
					if = {
						limit = {
							opinion = { who = ROOT value = 75 }
						}
						opinion = { who = PREV modifier = faction_disagree_liege multiplier = 2 months = 14 }
					}
				}
			}
			if = {
				limit = {
					opinion = { who = ROOT value = -25 }
					NOT = { opinion = { who = ROOT value = 25 } }
				}
				any_faction_backer = {
					limit = { pf_my_faction_backer_trigger = yes }
					if = {
						limit = {
							NOT = { opinion = { who = ROOT value = -75 } }
						}
						opinion = { who = PREV modifier = faction_disagree_liege months = 14 }
					}
					if = {
						limit = {
							opinion = { who = ROOT value = -25 }
							NOT = { opinion = { who = ROOT value = 25 } }
						}
						opinion = { who = PREV modifier = faction_agree_liege months = 14 }
					}
					if = {
						limit = {
							opinion = { who = ROOT value = 75 }
						}
						opinion = { who = PREV modifier = faction_disagree_liege months = 14 }
					}
				}
			}
			if = {
				limit = {
					opinion = { who = ROOT value = 25 }
					NOT = { opinion = { who = ROOT value = 75 } }
				}
				any_faction_backer = {
					limit = { pf_my_faction_backer_trigger = yes }
					if = {
						limit = {
							NOT = { opinion = { who = ROOT value = -75 } }
						}
						opinion = { who = PREV modifier = faction_disagree_liege multiplier = 2 months = 14 }
					}
					if = {
						limit = {
							opinion = { who = ROOT value = -75 }
							NOT = { opinion = { who = ROOT value = -25 } }
						}
						opinion = { who = PREV modifier = faction_disagree_liege months = 14 }
					}
					if = {
						limit = {
							opinion = { who = ROOT value = 25 }
							NOT = { opinion = { who = ROOT value = 75 } }
						}
						opinion = { who = PREV modifier = faction_agree_liege months = 14 }
					}
				}
			}
			if = {
				limit = {
					opinion = { who = ROOT value = 75 }
				}
				any_faction_backer = {
					limit = { pf_my_faction_backer_trigger = yes }
					if = {
						limit = {
							NOT = { opinion = { who = ROOT value = -75 } }
						}
						opinion = { who = PREV modifier = faction_disagree_liege multiplier = 3 months = 14 }
					}
					if = {
						limit = {
							opinion = { who = ROOT value = -75 }
							NOT = { opinion = { who = ROOT value = -25 } }
						}
						opinion = { who = PREV modifier = faction_disagree_liege multiplier = 2 months = 14 }
					}
					if = {
						limit = {
							opinion = { who = ROOT value = -25 }
							NOT = { opinion = { who = ROOT value = 25 } }
						}
						opinion = { who = PREV modifier = faction_disagree_liege months = 14 }
					}
					if = {
						limit = {
							opinion = { who = ROOT value = 75 }
						}
						opinion = { who = PREV modifier = faction_agree_liege months = 14 }
					}
				}
			}
		}

		character_event = { id = PlusFaction.222 } # completion effects
	}
}

# Faction maintenance setup effects
character_event = {
	id = PlusFaction.221

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		pf_reset_maintenance_vars_effect = yes

		#count the number of votes in each faction
		any_vassal = {
			limit = { in_faction = faction_court }
			if = {
				limit = { real_tier = BARON }
				ROOT = { change_variable = { which = "faction_votes_court" value = 1 } }
			}
			if = {
				limit = { real_tier = COUNT }
				ROOT = { change_variable = { which = "faction_votes_court" value = 2 } }
			}
			if = {
				limit = { real_tier = DUKE }
				ROOT = { change_variable = { which = "faction_votes_court" value = 4 } }
			}
			if = {
				limit = { real_tier = KING }
				ROOT = { change_variable = { which = "faction_votes_court" value = 8 } }
			}
		}
		any_vassal = {
			limit = { in_faction = faction_prosperity }
			if = {
				limit = { real_tier = BARON }
				ROOT = { change_variable = { which = "faction_votes_prosperity" value = 1 } }
			}
			if = {
				limit = { real_tier = COUNT }
				ROOT = { change_variable = { which = "faction_votes_prosperity" value = 2 } }
			}
			if = {
				limit = { real_tier = DUKE }
				ROOT = { change_variable = { which = "faction_votes_prosperity" value = 4 } }
			}
			if = {
				limit = { real_tier = KING }
				ROOT = { change_variable = { which = "faction_votes_prosperity" value = 8 } }
			}
		}
		any_vassal = {
			limit = { in_faction = faction_glory }
			if = {
				limit = { real_tier = BARON }
				ROOT = { change_variable = { which = "faction_votes_glory" value = 1 } }
			}
			if = {
				limit = { real_tier = COUNT }
				ROOT = { change_variable = { which = "faction_votes_glory" value = 2 } }
			}
			if = {
				limit = { real_tier = DUKE }
				ROOT = { change_variable = { which = "faction_votes_glory" value = 4 } }
			}
			if = {
				limit = { real_tier = KING }
				ROOT = { change_variable = { which = "faction_votes_glory" value = 8 } }
			}
		}
		any_vassal = {
			limit = { in_faction = faction_tradition }
			if = {
				limit = { real_tier = BARON }
				ROOT = { change_variable = { which = "faction_votes_tradition" value = 1 } }
			}
			if = {
				limit = { real_tier = COUNT }
				ROOT = { change_variable = { which = "faction_votes_tradition" value = 2 } }
			}
			if = {
				limit = { real_tier = DUKE }
				ROOT = { change_variable = { which = "faction_votes_tradition" value = 4 } }
			}
			if = {
				limit = { real_tier = KING }
				ROOT = { change_variable = { which = "faction_votes_tradition" value = 8 } }
			}
		}
	}
}

# Faction maintenance completion effects
character_event = {
	id = PlusFaction.222

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		#Now calculate each faction's mood, which is the  average of each faction member's
		#overall opinion of the liege, weighted by the number of votes they have in the faction
		any_vassal = {
			limit = { pf_member_trigger = yes }

			# set a number based on their opinion of the liege (from 1 to 100, 100 being the best)
			if = {
				limit = {
					opinion = { who = ROOT value = 75 }
				}
				ROOT = { set_variable = { which = "faction_member_approval" value = 100 } }
			}
			if = {
				limit = {
					NOT = { opinion = { who = ROOT value = 75 } }
					opinion = { who = ROOT value = 50 }
				}
				ROOT = { set_variable = { which = "faction_member_approval" value = 87.5 } }
			}
			if = {
				limit = {
					NOT = { opinion = { who = ROOT value = 50 } }
					opinion = { who = ROOT value = 25 }
				}
				ROOT = { set_variable = { which = "faction_member_approval" value = 75 } }
			}
			if = {
				limit = {
					NOT = { opinion = { who = ROOT value = 25 } }
					opinion = { who = ROOT value = 0 }
				}
				ROOT = { set_variable = { which = "faction_member_approval" value = 62.5 } }
			}
			if = {
				limit = {
					NOT = { opinion = { who = ROOT value = 0 } }
					opinion = { who = ROOT value = -25 }
				}
				ROOT = { set_variable = { which = "faction_member_approval" value = 50 } }
			}
			if = {
				limit = {
					NOT = { opinion = { who = ROOT value = -25 } }
					opinion = { who = ROOT value = -50 }
				}
				ROOT = { set_variable = { which = "faction_member_approval" value = 37.5 } }
			}
			if = {
				limit = {
					NOT = { opinion = { who = ROOT value = -50 } }
					opinion = { who = ROOT value = -75 }
				}
				ROOT = { set_variable = { which = "faction_member_approval" value = 25 } }
			}
			if = {
				limit = {
					NOT = { opinion = { who = ROOT value = -75 } }
					opinion = { who = ROOT value = -99 }
				}
				ROOT = { set_variable = { which = "faction_member_approval" value = 12.5 } }
			}
			if = {
				limit = {
					NOT = { opinion = { who = ROOT value = -99 } }
				}
				ROOT = { set_variable = { which = "faction_member_approval" value = 1 } }
			}

			# then multiply that number by the number of votes they have in the faction
			# NOTE: Barons would multiply x1, so no point in actually calculating that
			if = {
				limit = { real_tier = COUNT }
				ROOT = { multiply_variable = { which = "faction_member_approval" value = 2 } }
			}
			if = {
				limit = { real_tier = DUKE }
				ROOT = { multiply_variable = { which = "faction_member_approval" value = 4 } }
			}
			if = {
				limit = { real_tier = KING }
				ROOT = { multiply_variable = { which = "faction_member_approval" value = 8 } }
			}

			#then divide by the total number of votes in the faction and add that to the liege's mood variable
			if = {
				limit = { in_faction = faction_court }
				ROOT = {
					divide_variable = { which = "faction_member_approval" which = "faction_votes_court" }
					change_variable = { which = "faction_mood_court" which = "faction_member_approval" }
				}
			}
			if = {
				limit = { in_faction = faction_prosperity }
				ROOT = {
					divide_variable = { which = "faction_member_approval" which = "faction_votes_prosperity" }
					change_variable = { which = "faction_mood_prosperity" which = "faction_member_approval" }
				}
			}
			if = {
				limit = { in_faction = faction_glory }
				ROOT = {
					divide_variable = { which = "faction_member_approval" which = "faction_votes_glory" }
					change_variable = { which = "faction_mood_glory" which = "faction_member_approval" }
				}
			}
			if = {
				limit = { in_faction = faction_tradition }
				ROOT = {
					divide_variable = { which = "faction_member_approval" which = "faction_votes_tradition" }
					change_variable = { which = "faction_mood_tradition" which = "faction_member_approval" }
				}
			}
		}

		#Now determine the overall mood category of the faction and set the flag if it's different than before
		#and notify the liege if it's actually changed (and only then, to avoid spam)
		if = {
			limit = { any_vassal = { in_faction = faction_court } }
			if = {
				limit = {
					check_variable = { which = "faction_mood_court" value = 75 }
					NOT = { has_character_flag = faction_court_happy }
				}
				set_character_flag = faction_court_happy
				clr_character_flag = faction_court_unhappy
				clr_character_flag = faction_court_angry
				character_event = { id = PlusFaction.201 days = 1 }
				any_vassal = {
					limit = { in_faction = faction_court }
					character_event = { id = PlusFaction.201 days = 1 }
				}
			}
			if = {
				limit = {
					NOT = { check_variable = { which = "faction_mood_court" value = 75 } }
					check_variable = { which = "faction_mood_court" value = 50 }
					OR = {
						has_character_flag = faction_court_happy
						has_character_flag = faction_court_unhappy
						has_character_flag = faction_court_angry
					}	
				}
				clr_character_flag = faction_court_happy
				clr_character_flag = faction_court_unhappy
				clr_character_flag = faction_court_angry
				character_event = { id = PlusFaction.201 days = 1 }
				any_vassal = {
					limit = { in_faction = faction_court }
					character_event = { id = PlusFaction.201 days = 1 }
				}
			}				
			if = {
				limit = {
					check_variable = { which = "faction_mood_court" value = 37.5 }
					NOT = { check_variable = { which = "faction_mood_court" value = 50 } }
					NOT = { has_character_flag = faction_court_unhappy }
				}
				set_character_flag = faction_court_unhappy
				clr_character_flag = faction_court_happy
				clr_character_flag = faction_court_angry
				character_event = { id = PlusFaction.201 days = 1 }
				any_vassal = {
					limit = { in_faction = faction_court }
					character_event = { id = PlusFaction.201 days = 1 }
				}
			}
			if = {
				limit = {
					NOT = { check_variable = { which = "faction_mood_court" value = 37.5 } }
					NOT = { has_character_flag = faction_court_angry }
				}
				set_character_flag = faction_court_angry
				clr_character_flag = faction_court_unhappy
				clr_character_flag = faction_court_happy
				character_event = { id = PlusFaction.201 days = 1 }
				any_vassal = {
					limit = { in_faction = faction_court }
					character_event = { id = PlusFaction.201 days = 1 }
				}
			}
		}
		if = {
			limit = { any_vassal = { in_faction = faction_prosperity } }
			if = {
				limit = {
					check_variable = { which = "faction_mood_prosperity" value = 75 }
					NOT = { has_character_flag = faction_prosperity_happy }
				}
				set_character_flag = faction_prosperity_happy
				clr_character_flag = faction_prosperity_unhappy
				clr_character_flag = faction_prosperity_angry
				character_event = { id = PlusFaction.202 days = 1 }
				any_vassal = {
					limit = { in_faction = faction_prosperity }
					character_event = { id = PlusFaction.202 days = 1 }
				}
			}
			if = {
				limit = {
					NOT = { check_variable = { which = "faction_mood_prosperity" value = 75 } }
					check_variable = { which = "faction_mood_prosperity" value = 50 }
					OR = {
						has_character_flag = faction_prosperity_happy
						has_character_flag = faction_prosperity_unhappy
						has_character_flag = faction_prosperity_angry
					}	
				}
				clr_character_flag = faction_prosperity_happy
				clr_character_flag = faction_prosperity_unhappy
				clr_character_flag = faction_prosperity_angry
				character_event = { id = PlusFaction.202 days = 1 }
				any_vassal = {
					limit = { in_faction = faction_prosperity }
					character_event = { id = PlusFaction.202 days = 1 }
				}
			}
			if = {
				limit = {
					check_variable = { which = "faction_mood_prosperity" value = 37.5 }
					NOT = { check_variable = { which = "faction_mood_prosperity" value = 50 } }
					NOT = { has_character_flag = faction_prosperity_unhappy }
				}
				set_character_flag = faction_prosperity_unhappy
				clr_character_flag = faction_prosperity_happy
				clr_character_flag = faction_prosperity_angry
				character_event = { id = PlusFaction.202 days = 1 }
				any_vassal = {
					limit = { in_faction = faction_prosperity }
					character_event = { id = PlusFaction.202 days = 1 }
				}
			}
			if = {
				limit = {
					NOT = { check_variable = { which = "faction_mood_prosperity" value = 37.5 } }
					NOT = { has_character_flag = faction_prosperity_angry }
				}
				set_character_flag = faction_prosperity_angry
				clr_character_flag = faction_prosperity_unhappy
				clr_character_flag = faction_prosperity_happy
				character_event = { id = PlusFaction.202 days = 1 }
				any_vassal = {
					limit = { in_faction = faction_prosperity }
					character_event = { id = PlusFaction.202 days = 1 }
				}
			}
		}
		if = {
			limit = { any_vassal = { in_faction = faction_glory } }
			if = {
				limit = {
					check_variable = { which = "faction_mood_glory" value = 75 }
					NOT = { has_character_flag = faction_glory_happy }
				}
				set_character_flag = faction_glory_happy
				clr_character_flag = faction_glory_unhappy
				clr_character_flag = faction_glory_angry
				character_event = { id = PlusFaction.203 days = 1 }
				any_vassal = {
					limit = { in_faction = faction_glory }
					character_event = { id = PlusFaction.203 days = 1 }
				}
			}
			if = {
				limit = {
					NOT = { check_variable = { which = "faction_mood_glory" value = 75 } }
					check_variable = { which = "faction_mood_glory" value = 50 }
					OR = {
						has_character_flag = faction_glory_happy
						has_character_flag = faction_glory_unhappy
						has_character_flag = faction_glory_angry
					}	
				}
				clr_character_flag = faction_glory_happy
				clr_character_flag = faction_glory_unhappy
				clr_character_flag = faction_glory_angry
				character_event = { id = PlusFaction.203 days = 1 }
				any_vassal = {
					limit = { in_faction = faction_glory }
					character_event = { id = PlusFaction.203 days = 1 }
				}
			}
			if = {
				limit = {
					check_variable = { which = "faction_mood_glory" value = 37.5 }
					NOT = { check_variable = { which = "faction_mood_glory" value = 50 } }
					NOT = { has_character_flag = faction_glory_unhappy }
				}
				set_character_flag = faction_glory_unhappy
				clr_character_flag = faction_glory_happy
				clr_character_flag = faction_glory_angry
				character_event = { id = PlusFaction.203 days = 1 }
				any_vassal = {
					limit = { in_faction = faction_glory }
					character_event = { id = PlusFaction.203 days = 1 }
				}
			}
			if = {
				limit = {
					NOT = { check_variable = { which = "faction_mood_glory" value = 37.5 } }
					NOT = { has_character_flag = faction_glory_angry }
				}
				set_character_flag = faction_glory_angry
				clr_character_flag = faction_glory_unhappy
				clr_character_flag = faction_glory_happy
				character_event = { id = PlusFaction.203 days = 1 }
				any_vassal = {
					limit = { in_faction = faction_glory }
					character_event = { id = PlusFaction.203 days = 1 }
				}
			}
		}
		if = {
			limit = { any_vassal = { in_faction = faction_tradition } }
			if = {
				limit = {
					check_variable = { which = "faction_mood_tradition" value = 75 }
					NOT = { has_character_flag = faction_tradition_happy }
				}
				set_character_flag = faction_tradition_happy
				clr_character_flag = faction_tradition_unhappy
				clr_character_flag = faction_tradition_angry
				character_event = { id = PlusFaction.204 days = 1 }
				any_vassal = {
					limit = { in_faction = faction_tradition }
					character_event = { id = PlusFaction.204 days = 1 }
				}
			}
			if = {
				limit = {
					NOT = { check_variable = { which = "faction_mood_tradition" value = 75 } }
					check_variable = { which = "faction_mood_tradition" value = 50 }
					OR = {
						has_character_flag = faction_tradition_happy
						has_character_flag = faction_tradition_unhappy
						has_character_flag = faction_tradition_angry
					}	
				}
				clr_character_flag = faction_tradition_happy
				clr_character_flag = faction_tradition_unhappy
				clr_character_flag = faction_tradition_angry
				character_event = { id = PlusFaction.204 days = 1 }
				any_vassal = {
					limit = { in_faction = faction_tradition }
					character_event = { id = PlusFaction.204 days = 1 }
				}
			}
			if = {
				limit = {
					check_variable = { which = "faction_mood_tradition" value = 37.5 }
					NOT = { check_variable = { which = "faction_mood_tradition" value = 50 } }
					NOT = { has_character_flag = faction_tradition_unhappy }
				}
				set_character_flag = faction_tradition_unhappy
				clr_character_flag = faction_tradition_happy
				clr_character_flag = faction_tradition_angry
				character_event = { id = PlusFaction.204 days = 1 }
				any_vassal = {
					limit = { in_faction = faction_tradition }
					character_event = { id = PlusFaction.204 days = 1 }
				}
			}
			if = {
				limit = {
					NOT = { check_variable = { which = "faction_mood_tradition" value = 37.5 } }
					NOT = { has_character_flag = faction_tradition_angry }
				}
				set_character_flag = faction_tradition_angry
				clr_character_flag = faction_tradition_unhappy
				clr_character_flag = faction_tradition_happy
				character_event = { id = PlusFaction.204 days = 1 }
				any_vassal = {
					limit = { in_faction = faction_tradition }
					character_event = { id = PlusFaction.204 days = 1 }
				}
			}
		}
	}
}

# Helper to PlusFaction.200 in order to take advantage of `break = yes` (and more)
character_event = {
	id = PlusFaction.223

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		if = {
			limit = { is_variable_equal = { which = "faction_mood_increase" value = 1 } }
			opinion = { who = FROM modifier = faction_pleased years = 3 }
			any_faction_backer = {
				limit = { pf_my_faction_backer_trigger = yes }
				opinion = { who = FROM modifier = faction_pleased years = 3 }
			}
			break = yes
		}
		if = {
			limit = { is_variable_equal = { which = "faction_mood_increase" value = 2 } }
			opinion = { who = FROM modifier = faction_pleased years = 3 multiplier = 2 }
			any_faction_backer = {
				limit = { pf_my_faction_backer_trigger = yes }
				opinion = { who = FROM modifier = faction_pleased years = 3 multiplier = 2 }
			}
			break = yes
		}
		if = {
			limit = { is_variable_equal = { which = "faction_mood_increase" value = 3 } }
			opinion = { who = FROM modifier = faction_pleased years = 3 multiplier = 3 }
			any_faction_backer = {
				limit = { pf_my_faction_backer_trigger = yes }
				opinion = { who = FROM modifier = faction_pleased years = 3 multiplier = 3 }
			}
			break = yes
		}
		if = {
			limit = { is_variable_equal = { which = "faction_mood_increase" value = 4 } }
			opinion = { who = FROM modifier = faction_pleased years = 3 multiplier = 4 }
			any_faction_backer = {
				limit = { pf_my_faction_backer_trigger = yes }
				opinion = { who = FROM modifier = faction_pleased years = 3 multiplier = 4 }
			}
			break = yes
		}
		if = {
			limit = { is_variable_equal = { which = "faction_mood_increase" value = 5 } }
			opinion = { who = FROM modifier = faction_pleased years = 3 multiplier = 5 }
			any_faction_backer = {
				limit = { pf_my_faction_backer_trigger = yes }
				opinion = { who = FROM modifier = faction_pleased years = 3 multiplier = 5 }
			}
			break = yes
		}
		if = {
			limit = { is_variable_equal = { which = "faction_mood_increase" value = 6 } }
			opinion = { who = FROM modifier = faction_pleased years = 3 multiplier = 6 }
			any_faction_backer = {
				limit = { pf_my_faction_backer_trigger = yes }
				opinion = { who = FROM modifier = faction_pleased years = 3 multiplier = 6 }
			}
			break = yes
		}
		if = {
			limit = { is_variable_equal = { which = "faction_mood_increase" value = 7 } }
			opinion = { who = FROM modifier = faction_pleased years = 3 multiplier = 7 }
			any_faction_backer = {
				limit = { pf_my_faction_backer_trigger = yes }
				opinion = { who = FROM modifier = faction_pleased years = 3 multiplier = 7 }
			}
			break = yes
		}
		if = {
			limit = { is_variable_equal = { which = "faction_mood_increase" value = 8 } }
			opinion = { who = FROM modifier = faction_pleased years = 3 multiplier = 8 }
			any_faction_backer = {
				limit = { pf_my_faction_backer_trigger = yes }
				opinion = { who = FROM modifier = faction_pleased years = 3 multiplier = 8 }
			}
			break = yes
		}
		if = {
			limit = { is_variable_equal = { which = "faction_mood_increase" value = 9 } }
			opinion = { who = FROM modifier = faction_pleased years = 3 multiplier = 9 }
			any_faction_backer = {
				limit = { pf_my_faction_backer_trigger = yes }
				opinion = { who = FROM modifier = faction_pleased years = 3 multiplier = 9 }
			}
			break = yes
		}
		if = {
			limit = { check_variable = { which = "faction_mood_increase" value = 9.5 } }
			opinion = { who = FROM modifier = faction_pleased years = 3 multiplier = 10 }
			any_faction_backer = {
				limit = { pf_my_faction_backer_trigger = yes }
				opinion = { who = FROM modifier = faction_pleased years = 3 multiplier = 10 }
			}
			break = yes
		}
	}
}

# Helper to PlusFaction.200 in order to take advantage of `break = yes` (and more)
character_event = {
	id = PlusFaction.224

	is_triggered_only = yes
	hide_window = yes

	immediate = {
		if = {
			limit = { is_variable_equal = { which = "faction_mood_decrease" value = 1 } }
			opinion = { who = FROM modifier = faction_displeased years = 6 }
			any_faction_backer = {
				limit = { pf_my_faction_backer_trigger = yes }
				opinion = { who = FROM modifier = faction_displeased years = 6 }
			}
			break = yes
		}
		if = {
			limit = { is_variable_equal = { which = "faction_mood_decrease" value = 2 } }
			opinion = { who = FROM modifier = faction_displeased years = 6 multiplier = 2 }
			any_faction_backer = {
				limit = { pf_my_faction_backer_trigger = yes }
				opinion = { who = FROM modifier = faction_displeased years = 6 multiplier = 2 }
			}
			break = yes
		}
		if = {
			limit = { is_variable_equal = { which = "faction_mood_decrease" value = 3 } }
			opinion = { who = FROM modifier = faction_displeased years = 6 multiplier = 3 }
			any_faction_backer = {
				limit = { pf_my_faction_backer_trigger = yes }
				opinion = { who = FROM modifier = faction_displeased years = 6 multiplier = 3 }
			}
			break = yes
		}
		if = {
			limit = { is_variable_equal = { which = "faction_mood_decrease" value = 4 } }
			opinion = { who = FROM modifier = faction_displeased years = 6 multiplier = 4 }
			any_faction_backer = {
				limit = { pf_my_faction_backer_trigger = yes }
				opinion = { who = FROM modifier = faction_displeased years = 6 multiplier = 4 }
			}
			break = yes
		}
		if = {
			limit = { is_variable_equal = { which = "faction_mood_decrease" value = 5 } }
			opinion = { who = FROM modifier = faction_displeased years = 6 multiplier = 5 }
			any_faction_backer = {
				limit = { pf_my_faction_backer_trigger = yes }
				opinion = { who = FROM modifier = faction_displeased years = 6 multiplier = 5 }
			}
			break = yes
		}
		if = {
			limit = { is_variable_equal = { which = "faction_mood_decrease" value = 6 } }
			opinion = { who = FROM modifier = faction_displeased years = 6 multiplier = 6 }
			any_faction_backer = {
				limit = { pf_my_faction_backer_trigger = yes }
				opinion = { who = FROM modifier = faction_displeased years = 6 multiplier = 6 }
			}
			break = yes
		}
		if = {
			limit = { is_variable_equal = { which = "faction_mood_decrease" value = 7 } }
			opinion = { who = FROM modifier = faction_displeased years = 6 multiplier = 7 }
			any_faction_backer = {
				limit = { pf_my_faction_backer_trigger = yes }
				opinion = { who = FROM modifier = faction_displeased years = 6 multiplier = 7 }
			}
			break = yes
		}
		if = {
			limit = { is_variable_equal = { which = "faction_mood_decrease" value = 8 } }
			opinion = { who = FROM modifier = faction_displeased years = 6 multiplier = 8 }
			any_faction_backer = {
				limit = { pf_my_faction_backer_trigger = yes }
				opinion = { who = FROM modifier = faction_displeased years = 6 multiplier = 8 }
			}
			break = yes
		}
		if = {
			limit = { is_variable_equal = { which = "faction_mood_decrease" value = 9 } }
			opinion = { who = FROM modifier = faction_displeased years = 6 multiplier = 9 }
			any_faction_backer = {
				limit = { pf_my_faction_backer_trigger = yes }
				opinion = { who = FROM modifier = faction_displeased years = 6 multiplier = 9 }
			}
			break = yes
		}
		if = {
			limit = { check_variable = { which = "faction_mood_decrease" value = 9.5 } }
			opinion = { who = FROM modifier = faction_displeased years = 6 multiplier = 10 }
			any_faction_backer = {
				limit = { pf_my_faction_backer_trigger = yes }
				opinion = { who = FROM modifier = faction_displeased years = 6 multiplier = 10 }
			}
			break = yes
		}
	}
}

# PlusFaction.230-239 intended for handling alternate implementation of
# conditionally-deferred faction mood maintenance due to active mood
# impulses (an optimization, NOT a feature).

